name: Release

on:
  push:
    tags: ['v*']

jobs:
  validate:
    name: Validate Release
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check CHANGELOG has entry
        run: |
          TAG_VERSION="${GITHUB_REF#refs/tags/v}"
          if ! grep -q "## \[$TAG_VERSION\]" CHANGELOG.md; then
            echo "❌ No CHANGELOG entry for v$TAG_VERSION"
            echo ""
            echo "Add a section like:"
            echo "  ## [$TAG_VERSION] - $(date +%Y-%m-%d)"
            exit 1
          fi
          echo "✅ CHANGELOG entry found for v$TAG_VERSION"

  create-release:
    name: Create GitHub Release
    needs: validate
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: Extract changelog for this version
        id: changelog
        run: |
          TAG_VERSION="${GITHUB_REF#refs/tags/v}"
          # Extract section between this version and next version header (or EOF)
          NOTES=$(awk "/^## \[$TAG_VERSION\]/{flag=1; next} /^## \[/{flag=0} flag" CHANGELOG.md)

          # Handle multi-line output
          echo "notes<<EOF" >> $GITHUB_OUTPUT
          echo "$NOTES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        run: |
          gh release create ${{ github.ref_name }} \
            --title "Release ${{ github.ref_name }}" \
            --notes "${{ steps.changelog.outputs.notes }}"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

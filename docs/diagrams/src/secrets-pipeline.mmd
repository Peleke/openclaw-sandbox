graph LR
    subgraph HOST["Host (macOS)"]
        SECRET_FILE["~/.openclaw-secrets.env<br/><i>ANTHROPIC_API_KEY=sk-ant-xxx<br/>GH_TOKEN=ghp_xxx<br/>TELEGRAM_BOT_TOKEN=...</i>"]
        DIRECT["-e 'secrets_xxx=value'<br/>(direct injection)"]
        CONFIG_MOUNT["--config ~/.openclaw<br/>(.env in config dir)"]
    end

    subgraph ANSIBLE["Ansible (bootstrap.sh)"]
        PRIORITY["Priority Resolution<br/>1. Direct injection<br/>2. Secrets file<br/>3. Config mount"]
        REGEX["regex_search extraction<br/>(slurp + b64decode)"]
        TEMPLATE["Template: secrets.env.j2<br/>no_log: true"]
    end

    subgraph VM["Lima VM"]
        SECRETS_ENV["/etc/openclaw/secrets.env<br/>mode: 0600<br/>owner: user"]

        subgraph GATEWAY["Gateway Service"]
            ENV_FILE["EnvironmentFile=-<br/>/etc/openclaw/secrets.env"]
            GW_PROCESS["Gateway Process<br/>(secrets in memory only,<br/>NOT in process list)"]
        end

        subgraph SANDBOX["Docker Sandbox"]
            DOCKER_ENV["Container env passthrough<br/>sandbox.docker.env.GH_TOKEN<br/>= ${GH_TOKEN}"]
            CONTAINER_PROC["Container Process<br/>(gh respects GH_TOKEN)"]
        end
    end

    SECRET_FILE --> PRIORITY
    DIRECT --> PRIORITY
    CONFIG_MOUNT --> PRIORITY
    PRIORITY --> REGEX
    REGEX --> TEMPLATE
    TEMPLATE --> SECRETS_ENV
    SECRETS_ENV --> ENV_FILE
    ENV_FILE --> GW_PROCESS
    GW_PROCESS -->|env passthrough| DOCKER_ENV
    DOCKER_ENV --> CONTAINER_PROC

    style HOST fill:#e8f4f8,stroke:#2196F3
    style ANSIBLE fill:#fff3e0,stroke:#FF9800
    style VM fill:#e8f5e9,stroke:#4CAF50
    style GATEWAY fill:#f3e5f5,stroke:#9C27B0
    style SANDBOX fill:#fce4ec,stroke:#E91E63

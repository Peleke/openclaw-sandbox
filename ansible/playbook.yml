---
# OpenClaw Sandbox Provisioning Playbook
#
# Usage:
#   Normally run via bootstrap.sh, but can be run manually:
#   ansible-playbook -i inventory ansible/playbook.yml
#
- name: Provision OpenClaw Sandbox VM
  hosts: sandbox
  become: true

  vars:
    # Tenant configuration
    tenant_name: "{{ lookup('env', 'USER') | default('openclaw', true) }}"

    # Mount paths (set by bootstrap.sh or override)
    provision_path: /mnt/provision
    openclaw_path: /mnt/openclaw
    obsidian_path: /mnt/obsidian

    # OpenClaw configuration
    openclaw_user: openclaw
    openclaw_home: /home/openclaw
    openclaw_config_dir: "{{ openclaw_home }}/.openclaw"

    # Gateway settings
    gateway_port: 18789
    gateway_bind: "0.0.0.0"

    # Workspace path — set by overlay role (defaults to /mnt/openclaw if no overlay)
    workspace_path: "{{ overlay_workspace_path | default('/workspace') if (overlay_enabled | default(true) | bool and not (overlay_yolo_unsafe | default(false) | bool)) else openclaw_path }}"

  pre_tasks:
    - name: Display provisioning info
      ansible.builtin.debug:
        msg: |
          Provisioning OpenClaw Sandbox
          Tenant: {{ tenant_name }}
          OpenClaw source: {{ openclaw_path }}

    - name: Ensure apt cache is updated
      ansible.builtin.apt:
        update_cache: true
        cache_valid_time: 3600

  roles:
    # Phase S5: Secrets management (runs first to make secrets available)
    - role: secrets
      tags: [secrets]

    # Phase S9: Overlay filesystem isolation (before gateway so /workspace is ready)
    - role: overlay
      tags: [overlay]

    # Phase S10: Docker CE runtime (before gateway so docker group is ready)
    - role: docker
      tags: [docker]
      when: docker_enabled | default(true) | bool

    # GitHub CLI (after docker, before gateway — gh available when gateway starts)
    - role: gh-cli
      tags: [gh-cli]
      when: gh_cli_enabled | default(true) | bool

    # Phase S2: Gateway deployment
    - role: gateway
      tags: [gateway]

    # Phase S3: Network containment
    - role: firewall
      tags: [firewall]

    # Phase S4: Tailscale integration
    - role: tailscale
      tags: [tailscale]

    # Phase S7: Cadence ambient pipeline
    - role: cadence
      tags: [cadence]

    # Phase S8: buildlog ambient learning
    - role: buildlog
      tags: [buildlog]

    # Phase S10: Sandbox image + config (after gateway, needs workspace built)
    - role: sandbox
      tags: [sandbox]
      when: docker_enabled | default(true) | bool

    # Phase S9: Sync-gate helper scripts (after buildlog)
    - role: sync-gate
      tags: [sync-gate]
      when: overlay_enabled | default(true) | bool and not (overlay_yolo_unsafe | default(false) | bool)

  post_tasks:
    - name: Display completion message
      ansible.builtin.debug:
        msg: |
          OpenClaw Sandbox provisioning complete!
          Gateway will be available on port {{ gateway_port }}
          Workspace: {{ workspace_path }}
          {% if overlay_enabled | default(true) | bool and not (overlay_yolo_unsafe | default(false) | bool) %}
          Overlay: ACTIVE (host mounts are read-only)
          Sync to host: scripts/sync-gate.sh
          {% else %}
          Overlay: DISABLED (host mounts are writable)
          {% endif %}

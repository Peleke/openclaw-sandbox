---
# Qortex Interop Role
# Sets up seed exchange directories, installs qortex CLI, and deploys interop config

# Get the actual user home directory
- name: Get user home directory
  ansible.builtin.shell: "getent passwd {{ ansible_user }} | cut -d: -f6"
  register: user_home_result
  changed_when: false

- name: Set user_home fact
  ansible.builtin.set_fact:
    user_home: "{{ user_home_result.stdout }}"

# Create qortex seed exchange directories
- name: Create qortex seed directories
  ansible.builtin.file:
    path: "{{ user_home }}/.qortex/seeds/{{ item }}"
    state: directory
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
    mode: "0750"
  loop:
    - pending
    - processed
    - failed

- name: Create qortex signals directory
  ansible.builtin.file:
    path: "{{ user_home }}/.qortex/signals"
    state: directory
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
    mode: "0750"

# Ensure ~/.buildlog exists (guard for when buildlog role is disabled)
# Skip owner/group/mode to avoid chown failures on Lima mount symlinks
- name: Check if buildlog directory exists
  ansible.builtin.stat:
    path: "{{ user_home }}/.buildlog"
  register: buildlog_dir_check

- name: Create buildlog directory for interop config (if missing)
  when: not buildlog_dir_check.stat.exists
  ansible.builtin.file:
    path: "{{ user_home }}/.buildlog"
    state: directory
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
    mode: "0750"

# Deploy interop.yaml (buildlog <-> qortex seed exchange config)
- name: Check if interop.yaml exists
  ansible.builtin.stat:
    path: "{{ user_home }}/.buildlog/interop.yaml"
  register: interop_config

- name: Deploy buildlog interop config
  when: not interop_config.stat.exists
  ansible.builtin.template:
    src: interop.yaml.j2
    dest: "{{ user_home }}/.buildlog/interop.yaml"
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
    mode: "0640"

# Install qortex CLI via uv (if enabled and uv is available)
# NOTE: All uv tasks use become: false because the playbook has become: true
# at play level, but uv writes to ~/.local and ~/.cache which must be user-owned.
- name: Check if uv is installed
  become: false
  ansible.builtin.command: "{{ user_home }}/.local/bin/uv --version"
  register: uv_check
  changed_when: false
  failed_when: false

- name: Install uv (if not installed)
  become: false
  when: qortex_install | default(true) | bool and uv_check.rc != 0
  ansible.builtin.shell: |
    curl -LsSf https://astral.sh/uv/install.sh | sh
  args:
    creates: "{{ user_home }}/.local/bin/uv"
  environment:
    HOME: "{{ user_home }}"

- name: Set effective qortex extras (append memgraph when enabled)
  ansible.builtin.set_fact:
    _qortex_effective_extras: "{{ qortex_extras }}{{ ',memgraph' if (memgraph_enabled | default(false) | bool) else '' }}"

- name: Install qortex from local wheels
  become: false
  when:
    - qortex_install | default(true) | bool
    - qortex_wheel_dir | default('') | length > 0
  ansible.builtin.shell: |
    {{ user_home }}/.local/bin/uv tool install --force --reinstall --prerelease=allow \
      '{{ qortex_wheel_dir }}/qortex-*.whl[all]' \
      --with '{{ qortex_wheel_dir }}/qortex_online-*.whl[all]' \
      --with '{{ qortex_wheel_dir }}/qortex_observe-*.whl[all]' \
      --with '{{ qortex_wheel_dir }}/qortex_ingest-*.whl[all]' \
      --with 'sqlite-vec>=0.1.7a2'
  environment:
    HOME: "{{ user_home }}"
  register: qortex_install_result
  failed_when: false

- name: Install or upgrade qortex from PyPI
  become: false
  when:
    - qortex_install | default(true) | bool
    - qortex_wheel_dir | default('') | length == 0
  ansible.builtin.shell: |
    {{ user_home }}/.local/bin/uv tool install --upgrade --prerelease=allow \
      qortex{% if _qortex_effective_extras %}[{{ _qortex_effective_extras }}]{% endif %} \
      --with 'sqlite-vec>=0.1.7a2'
  environment:
    HOME: "{{ user_home }}"
  register: qortex_install_result
  failed_when: false

# sqlite-vec 0.1.6 ships a 32-bit ARM binary in the aarch64 wheel — force upgrade to fixed version
- name: Fix sqlite-vec arch mismatch (0.1.6 bug)
  become: false
  when: qortex_install | default(true) | bool
  ansible.builtin.shell: |
    {{ user_home }}/.local/bin/uv pip install --python $({{ user_home }}/.local/bin/uv tool dir)/qortex/bin/python --prerelease=allow "sqlite-vec>=0.1.7a2"
  environment:
    HOME: "{{ user_home }}"
  register: sqlite_vec_fix
  changed_when: "'Installed' in (sqlite_vec_fix.stdout | default(''))"
  failed_when: false

- name: Download spaCy en_core_web_sm model
  become: false
  when:
    - qortex_install | default(true) | bool
    - qortex_extraction | default('spacy') == 'spacy'
  ansible.builtin.shell: |
    {{ user_home }}/.local/bin/uv pip install \
      --python {{ user_home }}/.local/share/uv/tools/qortex/bin/python3 \
      en_core_web_sm@https://github.com/explosion/spacy-models/releases/download/en_core_web_sm-3.8.0/en_core_web_sm-3.8.0-py3-none-any.whl
  environment:
    HOME: "{{ user_home }}"
  register: spacy_model_result
  changed_when: "'Installed' in (spacy_model_result.stdout | default(''))"
  failed_when: false

- name: Display qortex install result
  when: qortex_install_result is defined and qortex_install_result.changed | default(false)
  ansible.builtin.debug:
    msg: "{{ qortex_install_result.stdout | default('qortex installed') }}"

# Deploy OTEL environment for qortex observability
- name: Deploy qortex OTEL profile.d script
  when: qortex_otel_enabled | default(false) | bool
  become: true
  ansible.builtin.template:
    src: qortex-otel.sh.j2
    dest: /etc/profile.d/qortex-otel.sh
    owner: root
    group: root
    mode: "0644"

- name: Deploy qortex OTEL env for systemd services
  when: qortex_otel_enabled | default(false) | bool
  become: true
  ansible.builtin.template:
    src: qortex-otel.env.j2
    dest: /etc/openclaw/qortex-otel.env
    owner: root
    group: root
    mode: "0644"

- name: Hook qortex OTEL into bash.bashrc for non-login shells
  when: qortex_otel_enabled | default(false) | bool
  become: true
  ansible.builtin.lineinfile:
    path: /etc/bash.bashrc
    line: '[ -r /etc/profile.d/qortex-otel.sh ] && . /etc/profile.d/qortex-otel.sh'
    insertafter: EOF
    state: present

- name: Qortex interop setup complete
  ansible.builtin.debug:
    msg: |
      ════════════════════════════════════════════════════════
      Qortex interop configured!

      Seed exchange dirs:
        ~/.qortex/seeds/{pending,processed,failed}
        ~/.qortex/signals/

      Interop config: ~/.buildlog/interop.yaml
      {% if qortex_install | default(true) | bool %}
      CLI: qortex (installed via uv tool)
      Extras: {{ _qortex_effective_extras | default(qortex_extras) | default('none') }}
      {% endif %}
      {% if qortex_otel_enabled | default(false) | bool %}
      OTEL: enabled → {{ qortex_otel_endpoint }}
      {% endif %}
      Extraction: {{ qortex_extraction | default('spacy') }}
      {% if memgraph_enabled | default(false) | bool %}
      Graph: memgraph (bolt://localhost:{{ memgraph_bolt_port | default(7687) }})
      Teleportation: enabled
      Credit propagation: enabled
      {% endif %}
      ════════════════════════════════════════════════════════

---
# Qortex Interop Role
# Sets up seed exchange directories, installs qortex CLI, and deploys interop config

# Get the actual user home directory
- name: Get user home directory
  ansible.builtin.shell: "getent passwd {{ ansible_user }} | cut -d: -f6"
  register: user_home_result
  changed_when: false

- name: Set user_home fact
  ansible.builtin.set_fact:
    user_home: "{{ user_home_result.stdout }}"

# Create qortex seed exchange directories
- name: Create qortex seed directories
  ansible.builtin.file:
    path: "{{ user_home }}/.qortex/seeds/{{ item }}"
    state: directory
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
    mode: "0750"
  loop:
    - pending
    - processed
    - failed

- name: Create qortex signals directory
  ansible.builtin.file:
    path: "{{ user_home }}/.qortex/signals"
    state: directory
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
    mode: "0750"

# Ensure ~/.buildlog exists (guard for when buildlog role is disabled)
# Skip owner/group/mode to avoid chown failures on Lima mount symlinks
- name: Check if buildlog directory exists
  ansible.builtin.stat:
    path: "{{ user_home }}/.buildlog"
  register: buildlog_dir_check

- name: Create buildlog directory for interop config (if missing)
  when: not buildlog_dir_check.stat.exists
  ansible.builtin.file:
    path: "{{ user_home }}/.buildlog"
    state: directory
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
    mode: "0750"

# Deploy interop.yaml (buildlog <-> qortex seed exchange config)
- name: Check if interop.yaml exists
  ansible.builtin.stat:
    path: "{{ user_home }}/.buildlog/interop.yaml"
  register: interop_config

- name: Deploy buildlog interop config
  when: not interop_config.stat.exists
  ansible.builtin.template:
    src: interop.yaml.j2
    dest: "{{ user_home }}/.buildlog/interop.yaml"
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
    mode: "0640"

# Install qortex CLI via uv (if enabled and uv is available)
# NOTE: All uv tasks use become: false because the playbook has become: true
# at play level, but uv writes to ~/.local and ~/.cache which must be user-owned.
- name: Check if uv is installed
  become: false
  ansible.builtin.command: "{{ user_home }}/.local/bin/uv --version"
  register: uv_check
  changed_when: false
  failed_when: false

- name: Install uv (if not installed)
  become: false
  when: qortex_install | default(true) | bool and uv_check.rc != 0
  ansible.builtin.shell: |
    curl -LsSf https://astral.sh/uv/install.sh | sh
  args:
    creates: "{{ user_home }}/.local/bin/uv"
  environment:
    HOME: "{{ user_home }}"

- name: Check if qortex is installed as uv tool
  become: false
  when: qortex_install | default(true) | bool
  ansible.builtin.shell: "{{ user_home }}/.local/bin/uv tool list | grep -q '^qortex '"
  register: qortex_check
  changed_when: false
  failed_when: false
  environment:
    HOME: "{{ user_home }}"

- name: Install qortex via uv tool
  become: false
  when: qortex_install | default(true) | bool and (qortex_check.rc | default(1)) != 0
  ansible.builtin.shell: |
    {{ user_home }}/.local/bin/uv tool install qortex{% if qortex_extras %}[{{ qortex_extras }}]{% endif %}
  environment:
    HOME: "{{ user_home }}"
  register: qortex_install_result
  failed_when: false

- name: Display qortex install result
  when: qortex_install_result is defined and qortex_install_result.changed | default(false)
  ansible.builtin.debug:
    msg: "{{ qortex_install_result.stdout | default('qortex installed') }}"

# Deploy OTEL environment for qortex observability
- name: Deploy qortex OTEL profile.d script
  when: qortex_otel_enabled | default(false) | bool
  become: true
  ansible.builtin.template:
    src: qortex-otel.sh.j2
    dest: /etc/profile.d/qortex-otel.sh
    owner: root
    group: root
    mode: "0644"

- name: Hook qortex OTEL into bash.bashrc for non-login shells
  when: qortex_otel_enabled | default(false) | bool
  become: true
  ansible.builtin.lineinfile:
    path: /etc/bash.bashrc
    line: '[ -r /etc/profile.d/qortex-otel.sh ] && . /etc/profile.d/qortex-otel.sh'
    insertafter: EOF
    state: present

- name: Qortex interop setup complete
  ansible.builtin.debug:
    msg: |
      ════════════════════════════════════════════════════════
      Qortex interop configured!

      Seed exchange dirs:
        ~/.qortex/seeds/{pending,processed,failed}
        ~/.qortex/signals/

      Interop config: ~/.buildlog/interop.yaml
      {% if qortex_install | default(true) | bool %}
      CLI: qortex (installed via uv tool)
      Extras: {{ qortex_extras | default('none') }}
      {% endif %}
      {% if qortex_otel_enabled | default(false) | bool %}
      OTEL: enabled → {{ qortex_otel_endpoint }}
      {% endif %}
      {% if memgraph_enabled | default(false) | bool %}
      Memgraph ports forwarded (7687, 3000, 7444)
      {% endif %}
      ════════════════════════════════════════════════════════

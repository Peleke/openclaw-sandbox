---
# Gateway Role - Phase S2
# Installs Node.js, builds OpenClaw, and configures the gateway service

# Get the actual user home directory (works with become: true at playbook level)
- name: Get user home directory
  ansible.builtin.shell: "getent passwd {{ ansible_user }} | cut -d: -f6"
  register: user_home_result
  changed_when: false

- name: Set user_home fact
  ansible.builtin.set_fact:
    user_home: "{{ user_home_result.stdout }}"

- name: Install prerequisites
  become: true
  ansible.builtin.apt:
    name:
      - unzip
      - curl
    state: present
    update_cache: true

- name: Check if Node.js is installed
  ansible.builtin.command: node --version
  register: node_version
  changed_when: false
  failed_when: false

- name: Install Node.js via NodeSource (if not installed)
  when: node_version.rc != 0
  block:
    - name: Download NodeSource setup script
      ansible.builtin.get_url:
        url: https://deb.nodesource.com/setup_22.x
        dest: /tmp/nodesource_setup.sh
        mode: "0755"

    - name: Run NodeSource setup script
      ansible.builtin.command: bash /tmp/nodesource_setup.sh
      become: true

    - name: Install Node.js
      ansible.builtin.apt:
        name: nodejs
        state: present
        update_cache: true
      become: true

    - name: Clean up setup script
      ansible.builtin.file:
        path: /tmp/nodesource_setup.sh
        state: absent

- name: Verify Node.js installation
  ansible.builtin.command: node --version
  register: node_installed_version
  changed_when: false

- name: Display Node.js version
  ansible.builtin.debug:
    msg: "Node.js version: {{ node_installed_version.stdout }}"

# Install bun for faster package management
- name: Check if bun is installed
  ansible.builtin.command: "{{ user_home }}/.bun/bin/bun --version"
  register: bun_version
  changed_when: false
  failed_when: false

- name: Install bun (if not installed)
  when: bun_version.rc != 0
  become: true
  become_user: "{{ ansible_user }}"
  ansible.builtin.shell: |
    curl -fsSL https://bun.sh/install | bash
  args:
    creates: "{{ user_home }}/.bun/bin/bun"
  environment:
    HOME: "{{ user_home }}"

# Handle config/auth - copy config files from mount, symlink agent data separately
# Strategy: ~/.openclaw/ is always a real directory (never a symlink).
# Config files are COPIED from the read-only mount so fix-vm-paths.yml can patch them.
# Agent data (green.db, learning.db) is symlinked to a writable mount for persistence.

# Check symlink BEFORE ensuring directory (symlink check must come first)
- name: Check if ~/.openclaw is a symlink (legacy)
  ansible.builtin.stat:
    path: "{{ user_home }}/.openclaw"
  register: openclaw_dir_stat

- name: Remove legacy ~/.openclaw symlink
  when: openclaw_dir_stat.stat.exists | default(false) and openclaw_dir_stat.stat.islnk | default(false)
  ansible.builtin.file:
    path: "{{ user_home }}/.openclaw"
    state: absent

- name: Ensure ~/.openclaw directory exists
  ansible.builtin.file:
    path: "{{ user_home }}/.openclaw"
    state: directory
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
    mode: "0750"

# Copy config files from mount (if available)
- name: Check if config mount exists
  ansible.builtin.stat:
    path: /mnt/openclaw-config
  register: config_mount

- name: Find config files on mount
  when: config_mount.stat.exists
  ansible.builtin.find:
    paths: /mnt/openclaw-config
    patterns: "*.json"
    file_type: file
  register: config_files_on_mount

- name: Copy config files from mount
  when: config_mount.stat.exists and (config_files_on_mount.files | default([]) | length > 0)
  ansible.builtin.copy:
    src: "{{ item.path }}"
    dest: "{{ user_home }}/.openclaw/{{ item.path | basename }}"
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
    mode: "0640"
    remote_src: true
  loop: "{{ config_files_on_mount.files }}"
  loop_control:
    label: "{{ item.path | basename }}"

# Copy identity subdirectories from mount (device auth, credentials, dotfiles)
# These contain agent identity state that must survive VM recreation:
#   identity/   — device-auth.json, device.json (gateway device identity)
#   credentials/ — telegram-allowFrom.json, telegram-pairing.json (pairing state)
#   dotfiles/   — env.sh, gateway.sh, setup.sh (runtime scripts)
- name: Copy identity directories from config mount
  when: config_mount.stat.exists
  ansible.builtin.copy:
    src: "/mnt/openclaw-config/{{ item }}/"
    dest: "{{ user_home }}/.openclaw/{{ item }}/"
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
    remote_src: true
  loop: "{{ config_identity_dirs }}"
  loop_control:
    label: "{{ item }}"
  failed_when: false

# Agent data persistence: symlink to writable mount
- name: Check if agent data mount exists
  ansible.builtin.stat:
    path: "{{ agent_data_mount | default('') }}"
  register: agent_data_mount_check
  when: agent_data_mount | default('') | length > 0

- name: Check existing agents directory
  ansible.builtin.stat:
    path: "{{ user_home }}/.openclaw/agents"
  register: existing_agents

- name: Remove existing agents directory if mount available
  when: >
    (agent_data_mount_check.stat.exists | default(false)) and
    (existing_agents.stat.exists | default(false)) and
    (existing_agents.stat.isdir | default(false)) and
    not (existing_agents.stat.islnk | default(false))
  ansible.builtin.file:
    path: "{{ user_home }}/.openclaw/agents"
    state: absent

- name: Symlink agents directory to persistent mount
  when: agent_data_mount_check.stat.exists | default(false)
  ansible.builtin.file:
    src: "{{ agent_data_mount }}"
    dest: "{{ user_home }}/.openclaw/agents"
    state: link
    force: true

- name: Display config status
  ansible.builtin.debug:
    msg: >-
      Config status:
      {% if config_mount.stat.exists %}
      Config files copied from host mount (local writable copy)
      {% else %}
      Fresh config directory created - run onboard to configure
      {% endif %}
      {% if agent_data_mount_check.stat.exists | default(false) %}
      | Agent data: symlinked to {{ agent_data_mount }} (persistent)
      {% else %}
      | Agent data: ephemeral (no --agent-data mount)
      {% endif %}

# Fix VM-specific paths (macOS paths don't work in Linux)
- name: Apply VM path fixes
  ansible.builtin.include_tasks: fix-vm-paths.yml

# Install OpenClaw dependencies
# Fix: Detect platform mismatch (macOS modules don't work on Linux)
- name: Check if node_modules exists
  ansible.builtin.stat:
    path: "{{ workspace_path }}/node_modules"
  register: node_modules

- name: Check node_modules platform marker
  when: node_modules.stat.exists
  ansible.builtin.stat:
    path: "{{ workspace_path }}/node_modules/.linux-installed"
  register: linux_marker

- name: Detect platform mismatch (reinstall if built on different platform)
  when: node_modules.stat.exists and not (linux_marker.stat.exists | default(false))
  block:
    - name: Clear existing node_modules (platform mismatch)
      ansible.builtin.file:
        path: "{{ workspace_path }}/node_modules"
        state: absent

    - name: Clear bun lockb (to force fresh install)
      ansible.builtin.file:
        path: "{{ workspace_path }}/bun.lockb"
        state: absent
      failed_when: false

- name: Re-check node_modules after potential cleanup
  ansible.builtin.stat:
    path: "{{ workspace_path }}/node_modules"
  register: node_modules_recheck

- name: Install OpenClaw dependencies (using bun)
  when: not node_modules_recheck.stat.exists
  ansible.builtin.shell: |
    export PATH="{{ user_home }}/.bun/bin:$PATH"
    cd {{ workspace_path }} && bun install
    touch {{ workspace_path }}/node_modules/.linux-installed
  register: bun_install_result

- name: Display bun install result
  when: bun_install_result is defined and bun_install_result.changed
  ansible.builtin.debug:
    msg: "Dependencies installed for Linux platform"

# Build OpenClaw (if not already built)
- name: Check if dist exists
  ansible.builtin.stat:
    path: "{{ workspace_path }}/dist/index.js"
  register: dist_exists

- name: Build OpenClaw
  when: not dist_exists.stat.exists
  ansible.builtin.shell: |
    export PATH="{{ user_home }}/.bun/bin:$PATH"
    cd {{ workspace_path }} && bun run build
  args:
    creates: "{{ workspace_path }}/dist/index.js"

# Check if obsidian vault overlay is available
- name: Check if obsidian vault mount exists
  ansible.builtin.stat:
    path: /mnt/obsidian
  register: obsidian_vault_mount

# Log rotation for gateway and overlay-watcher logs (#83)
- name: Ensure /var/log/openclaw directory exists
  become: true
  ansible.builtin.file:
    path: /var/log/openclaw
    state: directory
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
    mode: "0755"

- name: Deploy logrotate config for OpenClaw logs
  become: true
  ansible.builtin.copy:
    dest: /etc/logrotate.d/openclaw
    mode: "0644"
    content: |
      /var/log/openclaw/*.log {
          daily
          rotate 7
          compress
          delaycompress
          missingok
          notifempty
          copytruncate
          maxsize 50M
      }

# Cap Docker container log sizes (json-file driver)
- name: Ensure /etc/docker directory exists
  become: true
  ansible.builtin.file:
    path: /etc/docker
    state: directory
    mode: "0755"

- name: Check if Docker daemon.json exists
  ansible.builtin.stat:
    path: /etc/docker/daemon.json
  register: docker_daemon_json

- name: Read existing Docker daemon.json
  when: docker_daemon_json.stat.exists
  ansible.builtin.slurp:
    src: /etc/docker/daemon.json
  register: docker_daemon_content
  become: true

- name: Parse existing Docker daemon.json
  when: docker_daemon_json.stat.exists
  ansible.builtin.set_fact:
    docker_daemon_config: "{{ docker_daemon_content.content | b64decode | from_json }}"

- name: Set default Docker daemon config
  when: not docker_daemon_json.stat.exists
  ansible.builtin.set_fact:
    docker_daemon_config: {}

- name: Merge log rotation into Docker daemon.json
  ansible.builtin.set_fact:
    docker_daemon_config: >-
      {{ docker_daemon_config | combine({
        'log-driver': 'json-file',
        'log-opts': {
          'max-size': '50m',
          'max-file': '3'
        }
      }, recursive=true) }}

- name: Write Docker daemon.json
  become: true
  ansible.builtin.copy:
    content: "{{ docker_daemon_config | to_nice_json }}"
    dest: /etc/docker/daemon.json
    mode: "0644"
  notify: Restart docker

# Also cap journald to prevent unbounded growth
- name: Configure journald size limit
  become: true
  ansible.builtin.lineinfile:
    path: /etc/systemd/journald.conf
    regexp: '^#?SystemMaxUse='
    line: 'SystemMaxUse=200M'
  notify: Restart journald

# Create systemd service for gateway
- name: Create gateway systemd service
  become: true
  ansible.builtin.copy:
    dest: /etc/systemd/system/openclaw-gateway.service
    mode: "0644"
    content: |
      [Unit]
      Description=OpenClaw Gateway
      After=network.target{% if overlay_enabled | default(true) | bool and not (overlay_yolo_unsafe | default(false) | bool) %} workspace.mount{% endif %}

      {% if overlay_enabled | default(true) | bool and not (overlay_yolo_unsafe | default(false) | bool) %}
      Requires=workspace.mount
      {% endif %}

      [Service]
      Type=simple
      User={{ ansible_user }}
      {% if docker_enabled | default(true) | bool %}
      SupplementaryGroups=docker
      {% endif %}
      WorkingDirectory={{ workspace_path }}
      Environment=HOME={{ user_home }}
      Environment=PATH={{ user_home }}/.local/bin:{{ user_home }}/.bun/bin:/usr/local/bin:/usr/bin:/bin
      Environment=OPENCLAW_BUNDLED_PLUGINS_DIR={{ workspace_path }}/extensions
      {% if obsidian_vault_mount.stat.exists %}
      Environment=OBSIDIAN_VAULT_PATH=/workspace-obsidian
      {% endif %}
      # Load secrets from /etc/openclaw/secrets.env (- prefix = don't fail if missing)
      EnvironmentFile=-/etc/openclaw/secrets.env
      # Load qortex OTEL env vars (- prefix = don't fail if missing)
      EnvironmentFile=-/etc/openclaw/qortex-otel.env
      {% if overlay_enabled | default(true) | bool and not (overlay_yolo_unsafe | default(false) | bool) %}
      # Flush overlay dentry cache before start — host-side file edits can leave stale handles
      ExecStartPre=+/usr/bin/mount -o remount {{ workspace_path }}
      {% endif %}
      ExecStart=/usr/bin/node dist/index.js gateway --bind lan --port 18789 --allow-unconfigured
      Restart=on-failure
      RestartSec=5

      [Install]
      WantedBy=multi-user.target
  notify:
    - Reload systemd
    - Restart gateway after unit change

- name: Enable gateway service
  become: true
  ansible.builtin.systemd:
    name: openclaw-gateway
    enabled: true
    daemon_reload: true

# Check if onboard has been completed
- name: Check if gateway is configured
  ansible.builtin.stat:
    path: "{{ user_home }}/.openclaw/config.json"
  register: gateway_config

- name: Gateway configuration status
  ansible.builtin.debug:
    msg: >-
      {% if gateway_config.stat.exists %}
      Gateway is configured. Starting service...
      {% else %}
      Gateway NOT configured. Run: ./bootstrap.sh --onboard
      {% endif %}

# Only start if configured
- name: Start gateway service (if configured)
  become: true
  when: gateway_config.stat.exists
  ansible.builtin.systemd:
    name: openclaw-gateway
    state: started

- name: Gateway not started (needs onboard)
  when: not gateway_config.stat.exists
  ansible.builtin.debug:
    msg: |
      ============================================
      Gateway installed but NOT started.

      To configure the gateway, run:
        ./bootstrap.sh --onboard

      Then re-run bootstrap to start the service:
        ./bootstrap.sh
      ============================================

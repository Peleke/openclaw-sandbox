---
# Gateway Role - Phase S2
# Installs Node.js, builds OpenClaw, and configures the gateway service

# Get the actual user home directory (works with become: true at playbook level)
- name: Get user home directory
  ansible.builtin.shell: "getent passwd {{ ansible_user }} | cut -d: -f6"
  register: user_home_result
  changed_when: false

- name: Set user_home fact
  ansible.builtin.set_fact:
    user_home: "{{ user_home_result.stdout }}"

- name: Install prerequisites
  become: true
  ansible.builtin.apt:
    name:
      - unzip
      - curl
    state: present
    update_cache: true

- name: Check if Node.js is installed
  ansible.builtin.command: node --version
  register: node_version
  changed_when: false
  failed_when: false

- name: Install Node.js via NodeSource (if not installed)
  when: node_version.rc != 0
  block:
    - name: Download NodeSource setup script
      ansible.builtin.get_url:
        url: https://deb.nodesource.com/setup_22.x
        dest: /tmp/nodesource_setup.sh
        mode: "0755"

    - name: Run NodeSource setup script
      ansible.builtin.command: bash /tmp/nodesource_setup.sh
      become: true

    - name: Install Node.js
      ansible.builtin.apt:
        name: nodejs
        state: present
        update_cache: true
      become: true

    - name: Clean up setup script
      ansible.builtin.file:
        path: /tmp/nodesource_setup.sh
        state: absent

- name: Verify Node.js installation
  ansible.builtin.command: node --version
  register: node_installed_version
  changed_when: false

- name: Display Node.js version
  ansible.builtin.debug:
    msg: "Node.js version: {{ node_installed_version.stdout }}"

# Install bun for faster package management
- name: Check if bun is installed
  ansible.builtin.command: "{{ user_home }}/.bun/bin/bun --version"
  register: bun_version
  changed_when: false
  failed_when: false

- name: Install bun (if not installed)
  when: bun_version.rc != 0
  become: true
  become_user: "{{ ansible_user }}"
  ansible.builtin.shell: |
    curl -fsSL https://bun.sh/install | bash
  args:
    creates: "{{ user_home }}/.bun/bin/bun"
  environment:
    HOME: "{{ user_home }}"

# Handle config/auth - link from mount or create fresh
- name: Check if config mount exists
  ansible.builtin.stat:
    path: /mnt/openclaw-config
  register: config_mount

- name: Check if ~/.openclaw exists
  ansible.builtin.stat:
    path: "{{ user_home }}/.openclaw"
  register: openclaw_config

# Fix: Handle existing empty directory - replace with symlink if mount available
- name: Check if ~/.openclaw is empty directory (not symlink)
  when: openclaw_config.stat.exists and openclaw_config.stat.isdir and not openclaw_config.stat.islnk
  ansible.builtin.find:
    paths: "{{ user_home }}/.openclaw"
    file_type: any
  register: openclaw_config_contents

- name: Remove empty ~/.openclaw directory (to replace with symlink)
  when: >
    config_mount.stat.exists and
    openclaw_config.stat.exists and
    openclaw_config.stat.isdir and
    not openclaw_config.stat.islnk and
    (openclaw_config_contents.matched | default(0)) == 0
  ansible.builtin.file:
    path: "{{ user_home }}/.openclaw"
    state: absent

# Re-check after potential removal
- name: Re-check ~/.openclaw after cleanup
  ansible.builtin.stat:
    path: "{{ user_home }}/.openclaw"
  register: openclaw_config_recheck

- name: Link config from mount (if mounted and no existing config)
  when: config_mount.stat.exists and not openclaw_config_recheck.stat.exists
  ansible.builtin.file:
    src: /mnt/openclaw-config
    dest: "{{ user_home }}/.openclaw"
    state: link

- name: Create ~/.openclaw directory (if no mount and no existing)
  when: not config_mount.stat.exists and not openclaw_config_recheck.stat.exists
  ansible.builtin.file:
    path: "{{ user_home }}/.openclaw"
    state: directory
    mode: "0750"

- name: Display config status
  ansible.builtin.debug:
    msg: >-
      Config status:
      {% if config_mount.stat.exists %}
      Using mounted config from host
      {% elif openclaw_config.stat.exists %}
      Using existing config
      {% else %}
      Fresh config directory created - run onboard to configure
      {% endif %}

# Fix VM-specific paths (macOS paths don't work in Linux)
- name: Apply VM path fixes
  ansible.builtin.include_tasks: fix-vm-paths.yml

# Install OpenClaw dependencies
# Fix: Detect platform mismatch (macOS modules don't work on Linux)
- name: Check if node_modules exists
  ansible.builtin.stat:
    path: /mnt/openclaw/node_modules
  register: node_modules

- name: Check node_modules platform marker
  when: node_modules.stat.exists
  ansible.builtin.stat:
    path: /mnt/openclaw/node_modules/.linux-installed
  register: linux_marker

- name: Detect platform mismatch (reinstall if built on different platform)
  when: node_modules.stat.exists and not (linux_marker.stat.exists | default(false))
  block:
    - name: Clear existing node_modules (platform mismatch)
      ansible.builtin.file:
        path: /mnt/openclaw/node_modules
        state: absent

    - name: Clear bun lockb (to force fresh install)
      ansible.builtin.file:
        path: /mnt/openclaw/bun.lockb
        state: absent
      failed_when: false

- name: Re-check node_modules after potential cleanup
  ansible.builtin.stat:
    path: /mnt/openclaw/node_modules
  register: node_modules_recheck

- name: Install OpenClaw dependencies (using bun)
  when: not node_modules_recheck.stat.exists
  ansible.builtin.shell: |
    export PATH="{{ user_home }}/.bun/bin:$PATH"
    cd /mnt/openclaw && bun install
    touch /mnt/openclaw/node_modules/.linux-installed
  register: bun_install_result

- name: Display bun install result
  when: bun_install_result is defined and bun_install_result.changed
  ansible.builtin.debug:
    msg: "Dependencies installed for Linux platform"

# Build OpenClaw (if not already built)
- name: Check if dist exists
  ansible.builtin.stat:
    path: /mnt/openclaw/dist/index.js
  register: dist_exists

- name: Build OpenClaw
  when: not dist_exists.stat.exists
  ansible.builtin.shell: |
    export PATH="{{ user_home }}/.bun/bin:$PATH"
    cd /mnt/openclaw && bun run build
  args:
    creates: /mnt/openclaw/dist/index.js

# Create systemd service for gateway
- name: Create gateway systemd service
  become: true
  ansible.builtin.copy:
    dest: /etc/systemd/system/openclaw-gateway.service
    mode: "0644"
    content: |
      [Unit]
      Description=OpenClaw Gateway
      After=network.target

      [Service]
      Type=simple
      User={{ ansible_user }}
      WorkingDirectory=/mnt/openclaw
      Environment=HOME={{ user_home }}
      Environment=PATH={{ user_home }}/.bun/bin:/usr/local/bin:/usr/bin:/bin
      # Load secrets from /etc/openclaw/secrets.env (- prefix = don't fail if missing)
      EnvironmentFile=-/etc/openclaw/secrets.env
      ExecStart=/usr/bin/node dist/index.js gateway --bind lan --port 18789 --allow-unconfigured
      Restart=on-failure
      RestartSec=5

      [Install]
      WantedBy=multi-user.target
  notify: Reload systemd

- name: Enable gateway service
  become: true
  ansible.builtin.systemd:
    name: openclaw-gateway
    enabled: true
    daemon_reload: true

# Check if onboard has been completed
- name: Check if gateway is configured
  ansible.builtin.stat:
    path: "{{ user_home }}/.openclaw/config.json"
  register: gateway_config

- name: Gateway configuration status
  ansible.builtin.debug:
    msg: >-
      {% if gateway_config.stat.exists %}
      Gateway is configured. Starting service...
      {% else %}
      Gateway NOT configured. Run: ./bootstrap.sh --onboard
      {% endif %}

# Only start if configured
- name: Start gateway service (if configured)
  become: true
  when: gateway_config.stat.exists
  ansible.builtin.systemd:
    name: openclaw-gateway
    state: started

- name: Gateway not started (needs onboard)
  when: not gateway_config.stat.exists
  ansible.builtin.debug:
    msg: |
      ============================================
      Gateway installed but NOT started.

      To configure the gateway, run:
        ./bootstrap.sh --onboard

      Then re-run bootstrap to start the service:
        ./bootstrap.sh
      ============================================

---
# Fix VM-specific paths in OpenClaw config
# The host config has macOS paths that don't work in the Linux VM

- name: Check if config file exists
  ansible.builtin.stat:
    path: "{{ user_home }}/.openclaw/openclaw.json"
  register: config_file

- name: Fix VM paths in config (if config exists)
  when: config_file.stat.exists
  block:
    - name: Read current config
      ansible.builtin.slurp:
        src: "{{ user_home }}/.openclaw/openclaw.json"
      register: config_content

    - name: Parse config
      ansible.builtin.set_fact:
        openclaw_config: "{{ config_content.content | b64decode | from_json }}"

    - name: Fix workspace path (macOS -> Linux)
      ansible.builtin.set_fact:
        openclaw_config: >-
          {{ openclaw_config | combine({
            'agents': openclaw_config.agents | default({}) | combine({
              'defaults': (openclaw_config.agents.defaults | default({})) | combine({
                'workspace': user_home + '/.openclaw/workspace'
              })
            })
          }, recursive=true) }}
      when: openclaw_config.agents.defaults.workspace is defined and '/Users/' in (openclaw_config.agents.defaults.workspace | default(''))

    - name: Set Telegram dmPolicy to pairing (secure default)
      ansible.builtin.set_fact:
        openclaw_config: >-
          {{ openclaw_config | combine({
            'channels': openclaw_config.channels | default({}) | combine({
              'telegram': (openclaw_config.channels.telegram | default({})) | combine({
                'dmPolicy': 'pairing'
              })
            })
          }, recursive=true) }}
      when: openclaw_config.channels.telegram is defined

    - name: Pre-seed Telegram allowFrom with owner ID (if provided)
      ansible.builtin.set_fact:
        openclaw_config: >-
          {{ openclaw_config | combine({
            'channels': openclaw_config.channels | default({}) | combine({
              'telegram': (openclaw_config.channels.telegram | default({})) | combine({
                'allowFrom': [telegram_user_id | string]
              })
            })
          }, recursive=true) }}
      when: >
        openclaw_config.channels.telegram is defined and
        telegram_user_id is defined and telegram_user_id | string | length > 0

    # When qortex is enabled, ensure memorySearch has required fields so the agent
    # sees memory_search / memory_get and uses the qortex MCP backend.
    # Inject full block if missing; otherwise merge/patch to add enabled + qortex.command.
    - name: Inject memorySearch for qortex backend (when qortex enabled and not already set)
      ansible.builtin.set_fact:
        openclaw_config: >-
          {{ openclaw_config | combine({
            'agents': openclaw_config.agents | default({}) | combine({
              'defaults': (openclaw_config.agents.defaults | default({})) | combine({
                'memorySearch': {
                  'enabled': true,
                  'provider': 'qortex',
                  'qortex': {
                    'command': 'qortex mcp-serve',
                    'feedback': true
                  }
                }
              })
            })
          }, recursive=true) }}
      when: >
        (qortex_enabled | default(false) | bool) and
        ((openclaw_config.agents.defaults | default({})).memorySearch is not defined)

    - name: Patch memorySearch when qortex enabled and config exists but missing key fields
      ansible.builtin.set_fact:
        _ms: "{{ (openclaw_config.agents.defaults | default({})).memorySearch | default({}) }}"
      when: >
        (qortex_enabled | default(false) | bool) and
        ((openclaw_config.agents.defaults | default({})).memorySearch is defined)

    - name: Merge enabled and qortex.command into memorySearch
      ansible.builtin.set_fact:
        openclaw_config: >-
          {{ openclaw_config | combine({
            'agents': openclaw_config.agents | default({}) | combine({
              'defaults': (openclaw_config.agents.defaults | default({})) | combine({
                'memorySearch': _ms | combine({
                  'enabled': true,
                  'qortex': (_ms.qortex | default({})) | combine({
                    'command': (_ms.qortex | default({})).command | default('qortex mcp-serve')
                  })
                })
              })
            })
          }, recursive=true) }}
      when: _ms is defined

    # When qortex is enabled, ensure memory tools are allowed (alsoAllow group:memory)
    # so the agent sees memory_search / memory_get even when tools.profile is messaging.
    - name: Add group:memory to tools.alsoAllow when qortex enabled
      ansible.builtin.set_fact:
        openclaw_config: >-
          {{ openclaw_config | combine({
            'tools': (openclaw_config.tools | default({})) | combine({
              'alsoAllow': ((openclaw_config.tools.alsoAllow | default([])) + ['group:memory']) | unique | list
            })
          }, recursive=true) }}
      when: qortex_enabled | default(false) | bool

    # When qortex is enabled, inject learning config so the bandit system
    # (selectViaQortex / observeRunOutcomes) is live.  Shares the same
    # qortex MCP connection that memorySearch uses â€” no extra process.
    - name: Inject learning config for qortex backend (when qortex enabled)
      ansible.builtin.set_fact:
        openclaw_config: >-
          {{ openclaw_config | combine({
            'learning': {
              'enabled': true,
              'phase': 'active',
              'tokenBudget': 8000,
              'baselineRate': 0.10,
              'minPulls': 5,
              'qortex': {
                'command': 'qortex mcp-serve'
              },
              'learnerName': 'openclaw'
            }
          }, recursive=true) }}
      when: qortex_enabled | default(false) | bool

    # Ensure vault bind mount persists in sandbox config.
    # The sandbox role adds this during initial provisioning, but if the vault
    # overlay wasn't mounted yet or config was rewritten, re-add it here so
    # the agent can see the vault inside Docker sandbox containers.
    - name: Check if vault overlay is mounted
      ansible.builtin.stat:
        path: "{{ sandbox_vault_path | default('/workspace-obsidian') }}"
      register: vault_overlay_check

    - name: Ensure vault bind mount in sandbox docker config
      when: vault_overlay_check.stat.exists
      block:
        - name: Read existing sandbox config
          ansible.builtin.set_fact:
            _vault_bind: "{{ (sandbox_vault_path | default('/workspace-obsidian')) ~ ':' ~ (sandbox_vault_path | default('/workspace-obsidian')) ~ ':' ~ (sandbox_vault_access | default('rw')) }}"
            _sandbox_cfg: "{{ ((openclaw_config.agents | default({})).defaults | default({})).sandbox | default({}) }}"

        - name: Add vault bind mount if not already present
          ansible.builtin.set_fact:
            openclaw_config: >-
              {{ openclaw_config | combine({
                'agents': (openclaw_config.agents | default({})) | combine({
                  'defaults': ((openclaw_config.agents | default({})).defaults | default({})) | combine({
                    'sandbox': _sandbox_cfg | combine({
                      'docker': (_sandbox_cfg.docker | default({})) | combine({
                        'binds': ((_sandbox_cfg.docker | default({})).binds | default([])) + [_vault_bind]
                      })
                    })
                  })
                })
              }, recursive=true) }}
          when: _vault_bind not in ((_sandbox_cfg.docker | default({})).binds | default([]))

    # Ensure source repo bind mount persists in sandbox config.
    - name: Check if OpenClaw source is mounted
      ansible.builtin.stat:
        path: "{{ sandbox_source_path | default('/mnt/openclaw') }}"
      register: source_mount_check

    - name: Ensure source repo bind mount in sandbox docker config
      when: source_mount_check.stat.exists
      block:
        - name: Read existing sandbox config for source bind
          ansible.builtin.set_fact:
            _source_bind: "{{ (sandbox_source_path | default('/mnt/openclaw')) ~ ':' ~ (sandbox_source_mount | default('/openclaw-source')) ~ ':' ~ (sandbox_source_access | default('ro')) }}"
            _sandbox_cfg_src: "{{ ((openclaw_config.agents | default({})).defaults | default({})).sandbox | default({}) }}"

        - name: Add source repo bind mount if not already present
          ansible.builtin.set_fact:
            openclaw_config: >-
              {{ openclaw_config | combine({
                'agents': (openclaw_config.agents | default({})) | combine({
                  'defaults': ((openclaw_config.agents | default({})).defaults | default({})) | combine({
                    'sandbox': _sandbox_cfg_src | combine({
                      'docker': (_sandbox_cfg_src.docker | default({})) | combine({
                        'binds': ((_sandbox_cfg_src.docker | default({})).binds | default([])) + [_source_bind]
                      })
                    })
                  })
                })
              }, recursive=true) }}
          when: _source_bind not in ((_sandbox_cfg_src.docker | default({})).binds | default([]))

    # Inject path discovery env vars so the agent knows what's mounted
    - name: Build discovery env vars
      ansible.builtin.set_fact:
        _discovery_env: >-
          {{ {}
            | combine({'OBSIDIAN_VAULT_PATH': sandbox_vault_path | default('/workspace-obsidian')} if (vault_overlay_check.stat.exists | default(false)) else {})
            | combine({'OPENCLAW_SOURCE_PATH': sandbox_source_mount | default('/openclaw-source')} if (source_mount_check.stat.exists | default(false)) else {})
          }}

    - name: Merge discovery env vars into sandbox docker config
      when: _discovery_env | default({}) | length > 0
      ansible.builtin.set_fact:
        openclaw_config: >-
          {{ openclaw_config | combine({
            'agents': (openclaw_config.agents | default({})) | combine({
              'defaults': ((openclaw_config.agents | default({})).defaults | default({})) | combine({
                'sandbox': (((openclaw_config.agents | default({})).defaults | default({})).sandbox | default({})) | combine({
                  'docker': ((((openclaw_config.agents | default({})).defaults | default({})).sandbox | default({})).docker | default({})) | combine({
                    'env': (((((openclaw_config.agents | default({})).defaults | default({})).sandbox | default({})).docker | default({})).env | default({})) | combine(_discovery_env)
                  })
                })
              })
            })
          }, recursive=true) }}

    - name: Write fixed config
      ansible.builtin.copy:
        content: "{{ openclaw_config | to_nice_json }}"
        dest: "{{ user_home }}/.openclaw/openclaw.json"
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"
        mode: "0640"

    - name: Create workspace directory
      ansible.builtin.file:
        path: "{{ user_home }}/.openclaw/workspace"
        state: directory
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"
        mode: "0755"

    - name: Display path fixes applied
      ansible.builtin.debug:
        msg: |
          Applied VM path fixes:
          - workspace: {{ user_home }}/.openclaw/workspace
          - dmPolicy: pairing (unknown senders get a pairing code)
          {% if telegram_user_id is defined and telegram_user_id | string | length > 0 %}
          - allowFrom: [{{ telegram_user_id }}] (pre-seeded owner)
          {% else %}
          - allowFrom: not pre-seeded (approve via: claw pair approve <code>)
          {% endif %}
          {% if vault_overlay_check.stat.exists | default(false) %}
          - vault bind: {{ sandbox_vault_path | default('/workspace-obsidian') }} (rw in sandbox containers)
          {% else %}
          - vault bind: skipped (no vault overlay at {{ sandbox_vault_path | default('/workspace-obsidian') }})
          {% endif %}
          {% if source_mount_check.stat.exists | default(false) %}
          - source bind: {{ sandbox_source_path | default('/mnt/openclaw') }} -> {{ sandbox_source_mount | default('/openclaw-source') }} (ro)
          {% else %}
          - source bind: skipped (no source at {{ sandbox_source_path | default('/mnt/openclaw') }})
          {% endif %}
          {% if _discovery_env | default({}) | length > 0 %}
          - discovery env: {{ _discovery_env | to_json }}
          {% endif %}

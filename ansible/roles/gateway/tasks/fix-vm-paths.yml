---
# Fix VM-specific paths in OpenClaw config
# The host config has macOS paths that don't work in the Linux VM

- name: Check if config file exists
  ansible.builtin.stat:
    path: "{{ user_home }}/.openclaw/openclaw.json"
  register: config_file

- name: Fix VM paths in config (if config exists)
  when: config_file.stat.exists
  block:
    - name: Read current config
      ansible.builtin.slurp:
        src: "{{ user_home }}/.openclaw/openclaw.json"
      register: config_content

    - name: Parse config
      ansible.builtin.set_fact:
        openclaw_config: "{{ config_content.content | b64decode | from_json }}"

    - name: Fix workspace path (macOS -> Linux)
      ansible.builtin.set_fact:
        openclaw_config: >-
          {{ openclaw_config | combine({
            'agents': openclaw_config.agents | default({}) | combine({
              'defaults': (openclaw_config.agents.defaults | default({})) | combine({
                'workspace': user_home + '/.openclaw/workspace'
              })
            })
          }, recursive=true) }}
      when: openclaw_config.agents.defaults.workspace is defined and '/Users/' in (openclaw_config.agents.defaults.workspace | default(''))

    - name: Set Telegram dmPolicy to pairing (secure default)
      ansible.builtin.set_fact:
        openclaw_config: >-
          {{ openclaw_config | combine({
            'channels': openclaw_config.channels | default({}) | combine({
              'telegram': (openclaw_config.channels.telegram | default({})) | combine({
                'dmPolicy': 'pairing'
              })
            })
          }, recursive=true) }}
      when: openclaw_config.channels.telegram is defined

    - name: Pre-seed Telegram allowFrom with owner ID (if provided)
      ansible.builtin.set_fact:
        openclaw_config: >-
          {{ openclaw_config | combine({
            'channels': openclaw_config.channels | default({}) | combine({
              'telegram': (openclaw_config.channels.telegram | default({})) | combine({
                'allowFrom': [telegram_user_id | string]
              })
            })
          }, recursive=true) }}
      when: >
        openclaw_config.channels.telegram is defined and
        telegram_user_id is defined and telegram_user_id | string | length > 0

    # When qortex is enabled, ensure memorySearch has required fields so the agent
    # sees memory_search / memory_get and uses the qortex MCP backend.
    # Inject full block if missing; otherwise merge/patch to add enabled + qortex.command.
    - name: Inject memorySearch for qortex backend (when qortex enabled and not already set)
      ansible.builtin.set_fact:
        openclaw_config: >-
          {{ openclaw_config | combine({
            'agents': openclaw_config.agents | default({}) | combine({
              'defaults': (openclaw_config.agents.defaults | default({})) | combine({
                'memorySearch': {
                  'enabled': true,
                  'provider': 'qortex',
                  'qortex': {
                    'command': 'qortex mcp-serve',
                    'feedback': true
                  }
                }
              })
            })
          }, recursive=true) }}
      when: >
        (qortex_enabled | default(false) | bool) and
        ((openclaw_config.agents.defaults | default({})).memorySearch is not defined)

    - name: Patch memorySearch when qortex enabled and config exists but missing key fields
      ansible.builtin.set_fact:
        _ms: "{{ (openclaw_config.agents.defaults | default({})).memorySearch | default({}) }}"
      when: >
        (qortex_enabled | default(false) | bool) and
        ((openclaw_config.agents.defaults | default({})).memorySearch is defined)

    - name: Merge enabled and qortex.command into memorySearch
      ansible.builtin.set_fact:
        openclaw_config: >-
          {{ openclaw_config | combine({
            'agents': openclaw_config.agents | default({}) | combine({
              'defaults': (openclaw_config.agents.defaults | default({})) | combine({
                'memorySearch': _ms | combine({
                  'enabled': true,
                  'qortex': (_ms.qortex | default({})) | combine({
                    'command': (_ms.qortex | default({})).command | default('qortex mcp-serve')
                  })
                })
              })
            })
          }, recursive=true) }}
      when: _ms is defined

    # When qortex is enabled, ensure memory tools are allowed (alsoAllow group:memory)
    # so the agent sees memory_search / memory_get even when tools.profile is messaging.
    - name: Add group:memory to tools.alsoAllow when qortex enabled
      ansible.builtin.set_fact:
        openclaw_config: >-
          {{ openclaw_config | combine({
            'tools': (openclaw_config.tools | default({})) | combine({
              'alsoAllow': ((openclaw_config.tools.alsoAllow | default([])) + ['group:memory']) | unique | list
            })
          }, recursive=true) }}
      when: qortex_enabled | default(false) | bool

    - name: Write fixed config
      ansible.builtin.copy:
        content: "{{ openclaw_config | to_nice_json }}"
        dest: "{{ user_home }}/.openclaw/openclaw.json"
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"
        mode: "0640"

    - name: Create workspace directory
      ansible.builtin.file:
        path: "{{ user_home }}/.openclaw/workspace"
        state: directory
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"
        mode: "0755"

    - name: Display path fixes applied
      ansible.builtin.debug:
        msg: |
          Applied VM path fixes:
          - workspace: {{ user_home }}/.openclaw/workspace
          - dmPolicy: pairing (unknown senders get a pairing code)
          {% if telegram_user_id is defined and telegram_user_id | string | length > 0 %}
          - allowFrom: [{{ telegram_user_id }}] (pre-seeded owner)
          {% else %}
          - allowFrom: not pre-seeded (approve via: claw pair approve <code>)
          {% endif %}

---
# Fix VM-specific paths in OpenClaw config
# The host config has macOS paths that don't work in the Linux VM

- name: Check if config file exists
  ansible.builtin.stat:
    path: "{{ user_home }}/.openclaw/openclaw.json"
  register: config_file

- name: Fix VM paths in config (if config exists)
  when: config_file.stat.exists
  block:
    - name: Read current config
      ansible.builtin.slurp:
        src: "{{ user_home }}/.openclaw/openclaw.json"
      register: config_content

    - name: Parse config
      ansible.builtin.set_fact:
        openclaw_config: "{{ config_content.content | b64decode | from_json }}"

    - name: Fix workspace path (macOS -> Linux)
      ansible.builtin.set_fact:
        openclaw_config: >-
          {{ openclaw_config | combine({
            'agents': openclaw_config.agents | default({}) | combine({
              'defaults': (openclaw_config.agents.defaults | default({})) | combine({
                'workspace': user_home + '/.openclaw/workspace'
              })
            })
          }, recursive=true) }}
      when: openclaw_config.agents.defaults.workspace is defined and '/Users/' in (openclaw_config.agents.defaults.workspace | default(''))

    - name: Set Telegram dmPolicy to pairing (secure default)
      ansible.builtin.set_fact:
        openclaw_config: >-
          {{ openclaw_config | combine({
            'channels': openclaw_config.channels | default({}) | combine({
              'telegram': (openclaw_config.channels.telegram | default({})) | combine({
                'dmPolicy': 'pairing'
              })
            })
          }, recursive=true) }}
      when: openclaw_config.channels.telegram is defined

    - name: Pre-seed Telegram allowFrom with owner ID (if provided)
      ansible.builtin.set_fact:
        openclaw_config: >-
          {{ openclaw_config | combine({
            'channels': openclaw_config.channels | default({}) | combine({
              'telegram': (openclaw_config.channels.telegram | default({})) | combine({
                'allowFrom': [telegram_user_id | string]
              })
            })
          }, recursive=true) }}
      when: >
        openclaw_config.channels.telegram is defined and
        telegram_user_id is defined and telegram_user_id | string | length > 0

    - name: Write fixed config
      ansible.builtin.copy:
        content: "{{ openclaw_config | to_nice_json }}"
        dest: "{{ user_home }}/.openclaw/openclaw.json"
        mode: "0640"

    - name: Create workspace directory
      ansible.builtin.file:
        path: "{{ user_home }}/.openclaw/workspace"
        state: directory
        mode: "0750"

    - name: Display path fixes applied
      ansible.builtin.debug:
        msg: |
          Applied VM path fixes:
          - workspace: {{ user_home }}/.openclaw/workspace
          - dmPolicy: pairing (unknown senders get a pairing code)
          {% if telegram_user_id is defined and telegram_user_id | string | length > 0 %}
          - allowFrom: [{{ telegram_user_id }}] (pre-seeded owner)
          {% else %}
          - allowFrom: not pre-seeded (approve via: claw pair approve <code>)
          {% endif %}

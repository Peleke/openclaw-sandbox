#!/usr/bin/env bash
# {{ ansible_managed }}
# Clear overlay upper directory and remount (discard all writes)
# MUST be run as root
set -euo pipefail

UPPER="{{ sync_gate_upper_base }}/openclaw/upper"
WORK="{{ sync_gate_work_base }}/openclaw"
WORKSPACE="{{ sync_gate_workspace }}"

if [ "$(id -u)" -ne 0 ]; then
    echo "ERROR: must be run as root (use sudo)"
    exit 1
fi

echo "=== Overlay Reset ==="
echo ""
echo "This will DISCARD all writes in the overlay upper layer."
echo "Upper directory: $UPPER"
echo ""

# Show what will be lost
if [ -d "$UPPER" ]; then
    file_count=$(find "$UPPER" -type f 2>/dev/null | wc -l)
    echo "Files to discard: $file_count"
else
    echo "No files to discard."
    exit 0
fi

echo ""
read -rp "Are you sure? (y/N) " confirm
if [[ "$confirm" != "y" && "$confirm" != "Y" ]]; then
    echo "Aborted."
    exit 0
fi

echo ""
echo "Stopping services that use overlay..."
systemctl stop openclaw-gateway 2>/dev/null || true
systemctl stop openclaw-cadence 2>/dev/null || true
systemctl stop overlay-watcher 2>/dev/null || true

echo "Unmounting overlay..."
umount "$WORKSPACE" 2>/dev/null || true

echo "Clearing upper directory..."
rm -rf "${UPPER:?}"/*

echo "Clearing work directory..."
rm -rf "${WORK:?}"/*

echo "Remounting overlay..."
systemctl start workspace.mount

echo "Restarting services..."
systemctl start overlay-watcher
systemctl start openclaw-gateway 2>/dev/null || true
systemctl start openclaw-cadence 2>/dev/null || true

echo ""
echo "Overlay reset complete. All pending writes have been discarded."

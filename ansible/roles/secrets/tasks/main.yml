---
# Secrets Role - Phase S5
# Manages secrets from multiple sources with priority order:
# 1. Direct injection via -e "secrets_xxx=value" (CI/CD, testing)
# 2. Mounted secrets file at /mnt/secrets.env (recommended for dev)
# 3. Mounted config directory at /mnt/openclaw-config (existing users)
#
# Security:
# - Secrets file is mode 0600, owned by service user
# - All secret handling marked no_log: true
# - Uses EnvironmentFile= (not Environment=) to avoid process list exposure

- name: Skip secrets provisioning if requested
  when: secrets_skip | bool
  ansible.builtin.debug:
    msg: "Secrets provisioning skipped (secrets_skip=true)"

- name: Provision secrets
  when: not (secrets_skip | bool)
  block:
    # Step 1: Create secrets directory
    - name: Create secrets directory
      become: true
      ansible.builtin.file:
        path: "{{ secrets_env_dir }}"
        state: directory
        mode: "{{ secrets_env_dir_mode }}"
        owner: root
        group: root

    # Step 2: Check for secret sources
    - name: Build mounted secrets file path
      ansible.builtin.set_fact:
        mounted_secrets_path: "{{ secrets_mount_dir }}/{{ secrets_filename }}"
      when: secrets_filename | length > 0

    - name: Check if mounted secrets file exists
      ansible.builtin.stat:
        path: "{{ mounted_secrets_path | default('/mnt/secrets/.env') }}"
      register: mounted_secrets_file

    - name: Check if mounted config directory exists
      ansible.builtin.stat:
        path: /mnt/openclaw-config
      register: mounted_config_dir

    # Step 3: Determine which source to use and load secrets
    # Priority: Direct vars > Mounted secrets file > Mounted config

    - name: Check if any direct secrets are provided
      ansible.builtin.set_fact:
        has_direct_secrets: >-
          {{
            (secrets_anthropic_api_key | length > 0) or
            (secrets_openai_api_key | length > 0) or
            (secrets_gemini_api_key | length > 0) or
            (secrets_openrouter_api_key | length > 0) or
            (secrets_gateway_password | length > 0) or
            (secrets_gateway_token | length > 0) or
            (secrets_github_token | length > 0) or
            (secrets_slack_bot_token | length > 0) or
            (secrets_discord_bot_token | length > 0) or
            (secrets_telegram_bot_token | length > 0)
          }}

    # Source 1: Direct injection (already in vars, highest priority)
    - name: Use direct injection secrets
      when: has_direct_secrets | bool
      ansible.builtin.set_fact:
        secrets_source: "direct injection"

    # Source 2: Mounted secrets file
    - name: Load secrets from mounted file
      when:
        - not (has_direct_secrets | bool)
        - mounted_secrets_file.stat.exists
      block:
        - name: Read mounted secrets file
          ansible.builtin.slurp:
            path: "{{ mounted_secrets_path }}"
          register: mounted_secrets_content
          no_log: true

        - name: Parse mounted secrets
          ansible.builtin.set_fact:
            secrets_source: "mounted secrets file ({{ mounted_secrets_path }})"
          no_log: true

        - name: Extract secrets from mounted file
          ansible.builtin.set_fact:
            secrets_anthropic_api_key: "{{ (mounted_secrets_content.content | b64decode | regex_search('ANTHROPIC_API_KEY=(.+)', '\\1')) | default([''], true) | first }}"
            secrets_openai_api_key: "{{ (mounted_secrets_content.content | b64decode | regex_search('OPENAI_API_KEY=(.+)', '\\1')) | default([''], true) | first }}"
            secrets_gemini_api_key: "{{ (mounted_secrets_content.content | b64decode | regex_search('GEMINI_API_KEY=(.+)', '\\1')) | default([''], true) | first }}"
            secrets_openrouter_api_key: "{{ (mounted_secrets_content.content | b64decode | regex_search('OPENROUTER_API_KEY=(.+)', '\\1')) | default([''], true) | first }}"
            secrets_gateway_password: "{{ (mounted_secrets_content.content | b64decode | regex_search('OPENCLAW_GATEWAY_PASSWORD=(.+)', '\\1')) | default([''], true) | first }}"
            secrets_gateway_token: "{{ (mounted_secrets_content.content | b64decode | regex_search('OPENCLAW_GATEWAY_TOKEN=(.+)', '\\1')) | default([''], true) | first }}"
            secrets_github_token: "{{ (mounted_secrets_content.content | b64decode | regex_search('GH_TOKEN=(.+)', '\\1')) | default([''], true) | first }}"
            secrets_slack_bot_token: "{{ (mounted_secrets_content.content | b64decode | regex_search('SLACK_BOT_TOKEN=(.+)', '\\1')) | default([''], true) | first }}"
            secrets_discord_bot_token: "{{ (mounted_secrets_content.content | b64decode | regex_search('DISCORD_BOT_TOKEN=(.+)', '\\1')) | default([''], true) | first }}"
            secrets_telegram_bot_token: "{{ (mounted_secrets_content.content | b64decode | regex_search('TELEGRAM_BOT_TOKEN=(.+)', '\\1')) | default([''], true) | first }}"
          no_log: true

    # Source 3: Mounted config directory (check for .env or extract from config files)
    - name: Check for secrets in mounted config
      when:
        - not (has_direct_secrets | bool)
        - not mounted_secrets_file.stat.exists
        - mounted_config_dir.stat.exists
      block:
        - name: Check if config .env exists
          ansible.builtin.stat:
            path: /mnt/openclaw-config/.env
          register: config_env_file

        - name: Load secrets from config .env
          when: config_env_file.stat.exists
          block:
            - name: Read config .env file
              ansible.builtin.slurp:
                path: /mnt/openclaw-config/.env
              register: config_env_content
              no_log: true

            - name: Set secrets source to config .env
              ansible.builtin.set_fact:
                secrets_source: "mounted config directory (/mnt/openclaw-config/.env)"
              no_log: true

            - name: Extract secrets from config .env
              ansible.builtin.set_fact:
                secrets_anthropic_api_key: "{{ (config_env_content.content | b64decode | regex_search('ANTHROPIC_API_KEY=(.+)', '\\1')) | default([''], true) | first }}"
                secrets_openai_api_key: "{{ (config_env_content.content | b64decode | regex_search('OPENAI_API_KEY=(.+)', '\\1')) | default([''], true) | first }}"
                secrets_gemini_api_key: "{{ (config_env_content.content | b64decode | regex_search('GEMINI_API_KEY=(.+)', '\\1')) | default([''], true) | first }}"
                secrets_openrouter_api_key: "{{ (config_env_content.content | b64decode | regex_search('OPENROUTER_API_KEY=(.+)', '\\1')) | default([''], true) | first }}"
                secrets_gateway_password: "{{ (config_env_content.content | b64decode | regex_search('OPENCLAW_GATEWAY_PASSWORD=(.+)', '\\1')) | default([''], true) | first }}"
                secrets_gateway_token: "{{ (config_env_content.content | b64decode | regex_search('OPENCLAW_GATEWAY_TOKEN=(.+)', '\\1')) | default([''], true) | first }}"
                secrets_github_token: "{{ (config_env_content.content | b64decode | regex_search('GH_TOKEN=(.+)', '\\1')) | default([''], true) | first }}"
                secrets_slack_bot_token: "{{ (config_env_content.content | b64decode | regex_search('SLACK_BOT_TOKEN=(.+)', '\\1')) | default([''], true) | first }}"
                secrets_discord_bot_token: "{{ (config_env_content.content | b64decode | regex_search('DISCORD_BOT_TOKEN=(.+)', '\\1')) | default([''], true) | first }}"
                secrets_telegram_bot_token: "{{ (config_env_content.content | b64decode | regex_search('TELEGRAM_BOT_TOKEN=(.+)', '\\1')) | default([''], true) | first }}"
              no_log: true

        - name: Set source when no config .env
          when: not config_env_file.stat.exists
          ansible.builtin.set_fact:
            secrets_source: "mounted config directory (no .env found)"

    # Set default source if none matched
    - name: Set default secrets source
      when: secrets_source is not defined
      ansible.builtin.set_fact:
        secrets_source: "none (no secrets configured)"

    # Step 4: Check if we have any secrets to write
    - name: Check if any secrets are available
      ansible.builtin.set_fact:
        has_any_secrets: >-
          {{
            (secrets_anthropic_api_key | length > 0) or
            (secrets_openai_api_key | length > 0) or
            (secrets_gemini_api_key | length > 0) or
            (secrets_openrouter_api_key | length > 0) or
            (secrets_gateway_password | length > 0) or
            (secrets_gateway_token | length > 0) or
            (secrets_github_token | length > 0) or
            (secrets_slack_bot_token | length > 0) or
            (secrets_discord_bot_token | length > 0) or
            (secrets_telegram_bot_token | length > 0)
          }}

    # Step 5: Generate secrets.env file
    - name: Generate secrets environment file
      become: true
      ansible.builtin.template:
        src: secrets.env.j2
        dest: "{{ secrets_env_file }}"
        mode: "{{ secrets_env_file_mode }}"
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"
      no_log: true
      when: has_any_secrets | bool
      notify: Restart gateway service

    - name: Create empty secrets file (placeholder)
      become: true
      ansible.builtin.copy:
        content: |
          # OpenClaw Secrets Environment File
          # No secrets configured - add via:
          #   --secrets PATH     Mount a secrets .env file
          #   -e "secrets_xxx=value"  Direct injection
          #   --config PATH      Mount config directory with .env
        dest: "{{ secrets_env_file }}"
        mode: "{{ secrets_env_file_mode }}"
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"
        force: false
      when: not (has_any_secrets | bool)

    # Step 6: Display status (no secret values)
    - name: Display secrets provisioning status
      ansible.builtin.debug:
        msg: |
          Secrets provisioning complete
          Source: {{ secrets_source }}
          Output: {{ secrets_env_file }}
          Secrets configured: {{ has_any_secrets | bool }}
          {% if has_any_secrets | bool %}
          Available secrets:
          {% if secrets_anthropic_api_key | length > 0 %}  - ANTHROPIC_API_KEY{% endif %}
          {% if secrets_openai_api_key | length > 0 %}  - OPENAI_API_KEY{% endif %}
          {% if secrets_gemini_api_key | length > 0 %}  - GEMINI_API_KEY{% endif %}
          {% if secrets_openrouter_api_key | length > 0 %}  - OPENROUTER_API_KEY{% endif %}
          {% if secrets_gateway_password | length > 0 %}  - OPENCLAW_GATEWAY_PASSWORD{% endif %}
          {% if secrets_gateway_token | length > 0 %}  - OPENCLAW_GATEWAY_TOKEN{% endif %}
          {% if secrets_github_token | length > 0 %}  - GH_TOKEN{% endif %}
          {% if secrets_slack_bot_token | length > 0 %}  - SLACK_BOT_TOKEN{% endif %}
          {% if secrets_discord_bot_token | length > 0 %}  - DISCORD_BOT_TOKEN{% endif %}
          {% if secrets_telegram_bot_token | length > 0 %}  - TELEGRAM_BOT_TOKEN{% endif %}
          {% endif %}

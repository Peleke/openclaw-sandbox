---
# Cadence Role - Phase S7
# Sets up ambient AI pipeline for journal → insight → Telegram

# Get the actual user home directory (works with become: true)
- name: Get user home directory
  ansible.builtin.shell: "getent passwd {{ ansible_user }} | cut -d: -f6"
  register: user_home_result
  changed_when: false

- name: Set user_home fact
  ansible.builtin.set_fact:
    user_home: "{{ user_home_result.stdout }}"

- name: Check if Obsidian vault is mounted
  ansible.builtin.stat:
    path: "{{ cadence_vault_path }}"
  register: vault_mount

- name: Warn if vault not mounted
  when: not vault_mount.stat.exists
  ansible.builtin.debug:
    msg: |
      ⚠️  Obsidian vault not mounted at {{ cadence_vault_path }}
      Run: ./bootstrap.sh --vault ~/path/to/vault

- name: Check if Telegram is configured in gateway
  ansible.builtin.command: grep -q telegram "{{ user_home }}/.openclaw/openclaw.json"
  register: telegram_configured
  changed_when: false
  failed_when: false

- name: Warn if Telegram not configured
  when: telegram_configured.rc != 0
  ansible.builtin.debug:
    msg: |
      ⚠️  Telegram not configured in gateway.
      Cadence needs Telegram for delivery.

- name: Check if cadence.json exists
  ansible.builtin.stat:
    path: "{{ user_home }}/.openclaw/cadence.json"
  register: cadence_config

- name: Ensure .openclaw directory exists
  ansible.builtin.file:
    path: "{{ user_home }}/.openclaw"
    state: directory
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
    mode: "0750"

- name: Create cadence.json from template
  when: not cadence_config.stat.exists
  ansible.builtin.template:
    src: cadence.json.j2
    dest: "{{ user_home }}/.openclaw/cadence.json"
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
    mode: "0640"

- name: Read existing cadence.json
  when: cadence_config.stat.exists
  ansible.builtin.slurp:
    src: "{{ user_home }}/.openclaw/cadence.json"
  register: existing_cadence_config

- name: Parse existing config
  when: cadence_config.stat.exists
  ansible.builtin.set_fact:
    cadence_current: "{{ existing_cadence_config.content | b64decode | from_json }}"

- name: Fix vault path if pointing to macOS location
  when: >
    cadence_config.stat.exists and
    cadence_current.vaultPath is defined and
    '/Users/' in cadence_current.vaultPath
  block:
    - name: Update vault path in config
      ansible.builtin.set_fact:
        cadence_updated: >-
          {{ cadence_current | combine({
            'vaultPath': cadence_vault_path
          }) }}

    - name: Write fixed cadence.json
      ansible.builtin.copy:
        content: "{{ cadence_updated | to_nice_json }}"
        dest: "{{ user_home }}/.openclaw/cadence.json"
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"
        mode: "0640"

    - name: Display path fix
      ansible.builtin.debug:
        msg: "Fixed cadence vault path: {{ cadence_current.vaultPath }} → {{ cadence_vault_path }}"

# Setup LLM auth for Cadence (OpenClaw uses auth-profiles.json, not env vars directly)
- name: Check if secrets.env has ANTHROPIC_API_KEY
  ansible.builtin.shell: "grep -q '^ANTHROPIC_API_KEY=' /etc/openclaw/secrets.env 2>/dev/null"
  register: has_anthropic_key
  changed_when: false
  failed_when: false

- name: Create agent auth directory
  when: has_anthropic_key.rc == 0
  ansible.builtin.file:
    path: "{{ user_home }}/.openclaw/agents/main/agent"
    state: directory
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
    mode: "0750"

- name: Check if auth-profiles.json exists
  ansible.builtin.stat:
    path: "{{ user_home }}/.openclaw/agents/main/agent/auth-profiles.json"
  register: auth_profiles_exists

- name: Get Anthropic API key from secrets
  when: has_anthropic_key.rc == 0 and not auth_profiles_exists.stat.exists
  ansible.builtin.shell: "grep '^ANTHROPIC_API_KEY=' /etc/openclaw/secrets.env | cut -d'=' -f2"
  register: anthropic_key_result
  changed_when: false

- name: Create auth-profiles.json for LLM access
  when: has_anthropic_key.rc == 0 and not auth_profiles_exists.stat.exists
  ansible.builtin.copy:
    dest: "{{ user_home }}/.openclaw/agents/main/agent/auth-profiles.json"
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
    mode: "0600"
    content: |
      {
        "version": 1,
        "profiles": {
          "anthropic-sandbox": {
            "type": "api_key",
            "provider": "anthropic",
            "key": "{{ anthropic_key_result.stdout }}"
          }
        }
      }

- name: Warn if no Anthropic API key
  when: has_anthropic_key.rc != 0
  ansible.builtin.debug:
    msg: |
      ⚠️  No ANTHROPIC_API_KEY in /etc/openclaw/secrets.env
      Cadence LLM extraction will not work without it.
      Add your API key to the secrets file on the host.

# Create systemd service for persistent cadence
- name: Create cadence systemd service
  become: true
  ansible.builtin.copy:
    dest: /etc/systemd/system/openclaw-cadence.service
    mode: "0644"
    content: |
      [Unit]
      Description=OpenClaw Cadence Pipeline
      After=network.target openclaw-gateway.service
      Wants=openclaw-gateway.service

      [Service]
      Type=simple
      User={{ ansible_user }}
      WorkingDirectory=/mnt/openclaw
      Environment=HOME={{ user_home }}
      Environment=PATH={{ user_home }}/.bun/bin:/usr/local/bin:/usr/bin:/bin
      # Load secrets for LLM API access
      EnvironmentFile=-/etc/openclaw/secrets.env
      ExecStart={{ user_home }}/.bun/bin/bun scripts/cadence.ts start
      Restart=on-failure
      RestartSec=10

      [Install]
      WantedBy=multi-user.target
  notify: Reload systemd

- name: Enable cadence service
  become: true
  ansible.builtin.systemd:
    name: openclaw-cadence
    enabled: true
    daemon_reload: true

# Only start if enabled and prerequisites met
- name: Check cadence config state
  ansible.builtin.slurp:
    src: "{{ user_home }}/.openclaw/cadence.json"
  register: final_cadence_config

- name: Parse final config
  ansible.builtin.set_fact:
    cadence_final: "{{ final_cadence_config.content | b64decode | from_json }}"

- name: Cadence status check
  ansible.builtin.set_fact:
    cadence_ready: >-
      {{ cadence_final.enabled | default(false) and
         cadence_final.vaultPath | default('') | length > 0 and
         vault_mount.stat.exists }}

- name: Start cadence service (if ready)
  become: true
  when: cadence_ready
  ansible.builtin.systemd:
    name: openclaw-cadence
    state: started

- name: Cadence not started (needs config)
  when: not cadence_ready
  ansible.builtin.debug:
    msg: |
      ════════════════════════════════════════════════════════
      Cadence installed but NOT started.

      To configure:
        1. Edit config:
           limactl shell openclaw-sandbox -- nano ~/.openclaw/cadence.json

        2. Set:
           - "enabled": true
           - "vaultPath": "/mnt/obsidian"
           - "delivery.telegramChatId": "YOUR_CHAT_ID"

        3. Restart service:
           limactl shell openclaw-sandbox -- sudo systemctl restart openclaw-cadence

      Or run interactively:
        limactl shell openclaw-sandbox -- bun /mnt/openclaw/scripts/cadence.ts start
      ════════════════════════════════════════════════════════

- name: Cadence running
  when: cadence_ready
  ansible.builtin.debug:
    msg: |
      ✅ Cadence pipeline started!

      Watching: {{ cadence_final.vaultPath }}
      Delivery: {{ cadence_final.delivery.channel | default('telegram') }}
      Schedule: {{ 'Enabled' if cadence_final.schedule.enabled | default(false) else 'Disabled' }}

      Commands:
        # Check status
        limactl shell openclaw-sandbox -- sudo systemctl status openclaw-cadence

        # View logs
        limactl shell openclaw-sandbox -- sudo journalctl -u openclaw-cadence -f

        # Manual digest
        limactl shell openclaw-sandbox -- bun /mnt/openclaw/scripts/cadence.ts digest
